{% extends "base.html" %}

{% block title %}My Encounters: Map{% endblock %}

{% block html_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
    body {
    padding: 0;
    margin: 0;
}
html, body, #map {
    height: 85%;
    width: 100vw;
}
</style>
{% endblock %}


{% block content %}

<h2>My Encounters: Map</h2>
<h4><a href="{% url 'npl:my_encounters' %}">View in List</a></h4>

 <div id="map" ></div>

{% endblock %}


{% block scripts %}
<script>

function getResponseColor(response) {
 switch (response) {
  case 'RL':
   return 'red';
  case 'YL':
   return 'yellow';
  case 'GL':
   return 'green';
  case 'WT':
   return 'blue';
  case 'RT':
   return 'cyan';
 }
}

map_center = {{ map_center|safe }}

var mymap = L.map('map').setView([map_center.lat, map_center.lng], map_center.zoom);

var pins = {{ json|safe }}

for (var i=0; i<pins.length; i++) {
 pin = pins[i];
 if (pin && pin.lat != undefined && pin.lng != undefined){
  circleMarker = L.circleMarker([pin.lat, pin.lng], {radius: 10, color: getResponseColor(pin.response), opacity: 0.2}).addTo(mymap)
   .bindPopup(`<h3>${pin.name} (${pin.response})</h3>${pin.full_address}<br><strong>${pin.actions.join(', ')}</strong><br>${pin.date_time}`)
 }
}

L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.streets',
    accessToken: 'pk.eyJ1IjoicmNsZWFyeXVzYyIsImEiOiJjamZhOWN6eGowZXhzMzNtMW8xYm5kYW8wIn0.DIcgQIF3StLhEwz0lIMJJw'
}).addTo(mymap);


</script>
{% endblock %}